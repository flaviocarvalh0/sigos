<div class="card shadow-sm" [class.border-0]="modoEmbedded" [class.p-3]="modoEmbedded">
  <div class="card-header bg-primary text-white" *ngIf="!modoEmbedded">
    <h4 class="mb-0">
        <i class="bi bi-phone me-2"></i>{{ cardTitle }}
    </h4>
  </div>
  <div class="card-body" [class.p-0]="modoEmbedded">
    <div *ngIf="isLoading" class="text-center my-5">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Carregando...</span>
      </div>
      <p class="mt-2">Processando dados do aparelho...</p>
    </div>

    <form [formGroup]="formAparelho" (ngSubmit)="onSubmit()" *ngIf="!isLoading" novalidate>
      <div class="mb-3" *ngIf="!modoEmbedded || (modoEmbedded && !clienteIdInput)">
        <label for="idCliente" class="form-label">Cliente <span class="text-danger">*</span></label>
        <ng-select [items]="clientes"
                   bindLabel="nomeCompleto"
                   bindValue="id"
                   formControlName="idCliente"
                   placeholder="Selecione o cliente"
                   [searchable]="true"
                   [clearable]="true"
                   [ngClass]="{'is-invalid': formAparelho.get('idCliente')?.touched && formAparelho.get('idCliente')?.invalid}">
        </ng-select>
        <div *ngIf="formAparelho.get('idCliente')?.touched && formAparelho.get('idCliente')?.invalid" class="invalid-feedback d-block">
          Cliente é obrigatório.
        </div>
      </div>
      <div *ngIf="modoEmbedded && clienteIdInput" class="mb-3">
        </div>


      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="idMarca" class="form-label">Marca <span class="text-danger">*</span></label>
          <ng-select [items]="marcas"
                     bindLabel="nome"
                     bindValue="id"
                     formControlName="idMarca"
                     placeholder="Selecione a marca"
                     (change)="onMarcaChange()"
                     [searchable]="true"
                     [clearable]="true"
                     [ngClass]="{'is-invalid': formAparelho.get('idMarca')?.touched && formAparelho.get('idMarca')?.invalid}">
          </ng-select>
          <div *ngIf="formAparelho.get('idMarca')?.touched && formAparelho.get('idMarca')?.invalid" class="invalid-feedback d-block">
            Marca é obrigatória.
          </div>
        </div>

        <div class="col-md-6 mb-3">
          <label for="idModelo" class="form-label">Modelo <span class="text-danger">*</span></label>
          <ng-select [items]="modelosFiltrados"
                     bindLabel="nome"
                     bindValue="id"
                     formControlName="idModelo"
                     placeholder="Selecione o modelo"
                     [searchable]="true"
                     [clearable]="true"
                     [disabled]="!formAparelho.get('idMarca')?.value"
                     [ngClass]="{'is-invalid': formAparelho.get('idModelo')?.touched && formAparelho.get('idModelo')?.invalid}">
          </ng-select>
          <div *ngIf="formAparelho.get('idModelo')?.touched && formAparelho.get('idModelo')?.invalid" class="invalid-feedback d-block">
            Modelo é obrigatório.
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
            <label for="imei1" class="form-label">IMEI 1 <span class="text-danger">*</span></label>
            <input id="imei1" type="text" class="form-control" formControlName="imei1" placeholder="Digite o IMEI principal"
                   [ngClass]="{'is-invalid': formAparelho.get('imei1')?.touched && formAparelho.get('imei1')?.invalid}" maxlength="15">
            <div *ngIf="formAparelho.get('imei1')?.touched && formAparelho.get('imei1')?.invalid" class="invalid-feedback">
              <span *ngIf="formAparelho.get('imei1')?.errors?.['required']">IMEI 1 é obrigatório.</span>
              <span *ngIf="formAparelho.get('imei1')?.errors?.['minlength'] || formAparelho.get('imei1')?.errors?.['maxlength']">IMEI deve ter entre 14 e 15 dígitos.</span>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <label for="imei2" class="form-label">IMEI 2</label>
            <input id="imei2" type="text" class="form-control" formControlName="imei2" placeholder="IMEI secundário (opcional)"
                  [ngClass]="{'is-invalid': formAparelho.get('imei2')?.touched && formAparelho.get('imei2')?.invalid}" maxlength="15">
            <div *ngIf="formAparelho.get('imei2')?.touched && formAparelho.get('imei2')?.invalid" class="invalid-feedback">
                <span *ngIf="formAparelho.get('imei2')?.errors?.['minlength'] || formAparelho.get('imei2')?.errors?.['maxlength']">IMEI deve ter entre 14 e 15 dígitos.</span>
            </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
            <label for="numeroSerie" class="form-label">Número de Série <span class="text-danger">*</span></label>
            <input id="numeroSerie" type="text" class="form-control" formControlName="numeroSerie" placeholder="Número de série do aparelho"
                   [ngClass]="{'is-invalid': formAparelho.get('numeroSerie')?.touched && formAparelho.get('numeroSerie')?.invalid}">
            <div *ngIf="formAparelho.get('numeroSerie')?.touched && formAparelho.get('numeroSerie')?.invalid" class="invalid-feedback">
              <span *ngIf="formAparelho.get('numeroSerie')?.errors?.['required']">Número de Série é obrigatório.</span>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <label for="cor" class="form-label">Cor <span class="text-danger">*</span></label>
            <input id="cor" type="text" class="form-control" formControlName="cor" placeholder="Cor do aparelho"
                  [ngClass]="{'is-invalid': formAparelho.get('cor')?.touched && formAparelho.get('cor')?.invalid}">
            <div *ngIf="formAparelho.get('cor')?.touched && formAparelho.get('cor')?.invalid" class="invalid-feedback">
                <span *ngIf="formAparelho.get('cor')?.errors?.['required']">Cor é obrigatória.</span>
            </div>
        </div>
      </div>

      <div class="mb-3">
        <label for="descricaoAuxiliar" class="form-label">Descrição Auxiliar</label>
        <input id="descricaoAuxiliar" type="text" class="form-control" formControlName="descricaoAuxiliar" placeholder="Ex: iPhone 13 Pro Max 256GB Azul Sierra">
      </div>

      <div class="mb-3">
        <label for="observacoes" class="form-label">Observações</label>
        <textarea id="observacoes" class="form-control" formControlName="observacoes" rows="3"
          placeholder="Detalhes adicionais, avarias, acessórios inclusos, etc."></textarea>
      </div>

      <div class="d-flex mt-4" [class.justify-content-end]="modoEmbedded" [class.justify-content-between]="!modoEmbedded">
        <button type="button" class="btn btn-secondary me-2" (click)="onHandleCancelar()">
            <i class="bi bi-x-lg me-1"></i>Cancelar
        </button>
        <button *ngIf="isEditando && !modoEmbedded" type="button" class="btn btn-danger me-2" (click)="onExcluir()" [disabled]="isLoading">
             <span *ngIf="!isLoading"><i class="bi bi-trash me-1"></i> Excluir</span>
             <span *ngIf="isLoading"><span class="spinner-border spinner-border-sm me-1"></span> Excluindo...</span>
        </button>
        <button type="submit" class="btn btn-success" [disabled]="formAparelho.invalid || isLoading">
          <span *ngIf="!isLoading"><i class="bi bi-check-lg me-1"></i> {{ saveButtonText }}</span>
          <span *ngIf="isLoading"><span class="spinner-border spinner-border-sm me-1"></span> Salvando...</span>
        </button>
      </div>
    </form>
  </div>
</div>